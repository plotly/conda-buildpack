#!/usr/bin/env bash
set -eo pipefail

puts-step "Initializing .condarc"
touch /app/.heroku/miniconda/.condarc
if [[ -f .condarc ]]; then
  cp -f .condarc /app/.heroku/miniconda
fi

echo "nomkl" > $HOME/.heroku/miniconda/conda-meta/pinned
echo "python <3.8.0" >> $HOME/.heroku/miniconda/conda-meta/pinned
# Pin the conda version if proper version, not `latest` or anything else
if [[ $CONDA_VERSION =~ ^[0-9]+(\.[0-9]+)*$ ]]; then
  echo "conda ==${CONDA_VERSION}" >> $HOME/.heroku/miniconda/conda-meta/pinned
fi

conda config --set auto_update_conda False
conda install $MINICONDA_VERBOSITY --no-update-deps pip --yes | indent
conda install $MINICONDA_VERBOSITY --no-update-deps nomkl --yes | indent


puts-step "Installing dependencies using Conda"
conda install $MINICONDA_VERBOSITY --no-update-deps --file conda-requirements.txt --yes | indent

if [[ -f requirements.txt ]]; then
  puts-step "Installing dependencies using Pip"
  pip install -r requirements.txt  --exists-action=w | indent
fi

# Clean up the installation environment .
conda clean -pt --yes > /dev/null
